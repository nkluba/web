<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Region and City Selection</title>
    <style>
        #region-select,
        #stop-select {
            display: none;
        }
    
        .autocomplete {
            position: relative;
            display: inline-block;
        }
    
        .autocomplete-list {
            position: absolute;
            z-index: 1;
            width: 100%;
            background-color: #f1f1f1;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
    
        .autocomplete-list div {
            padding: 10px;
            cursor: pointer;
        }
    
        .autocomplete-list div:hover {
            background-color: #ddd;
        }
    </style>
</head>

<body>

    <div class="container mx-auto mt-10 bg-white">
        <div class="mb-4 p-6">
            <h2>Select a Region and City in Estonia</h2>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <label for="region-autocomplete">Select a Region</label>
                    <div class="mb-4">
                        <form id="region-form">
                            <label for="region-autocomplete">Select a Region</label>
                            <div id="region-autocomplete">
                                <input type="text" id="region-input" placeholder="Type a region..." name="region">
                                <select id="region-select" name="region">
                                    <option disabled selected>Select a region...</option>
                                    {% for region in regions %}
                                        <option>{{ region }}</option>
                                    {% endfor %}
                                </select>
                                <div id="region-list"></div>
                            </div>
                            <button id="submit-region" type="button">Submit Region</button>
                        </form>
                    </div>
                    
                    <!-- Stop Form -->
                    <div class="mb-4">
                        <form id="stop-form" action="/search" method="get">
                            <label for="stop-autocomplete">Select a Stop</label>
                            <div id="stop-autocomplete" class="autocomplete">
                                <input type="text" id="stop-input" placeholder="Type a stop..." name="stop">
                                <div id="stop-list"></div>
                            </div>
                            <button type="submit">Submit</button>
                        </form>
                    </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
    const regionInput = document.getElementById("region-input");
    const regionSelect = document.getElementById("region-select");
    const regionList = document.getElementById("region-list");

    const stopInput = document.getElementById("stop-input");
    const stopList = document.getElementById("stop-list");

    const submitRegionButton = document.getElementById("submit-region");
    const regionForm = document.getElementById("region-form");

    submitRegionButton.addEventListener("click", function () {
        const selectedRegion = regionInput.value || regionSelect.value;

        if (selectedRegion) {
            // Fetch stops for the selected region and update stop dropdown
            fetch(`/get_stops?region=${selectedRegion}`)
                .then(response => response.json())
                .then(data => updateStopDropdown(data.stops))
                .catch(error => console.error('Error fetching stops:', error));
        }
    });

    // Event listener for region input
    regionInput.addEventListener("input", function () {
        const inputValue = this.value.toLowerCase();
        const options = Array.from(regionSelect.options);

        const filteredOptions = options.filter(option => {
            return option.text.toLowerCase().includes(inputValue);
        });

        regionList.innerHTML = "";
        filteredOptions.forEach(option => {
            const listItem = document.createElement("div");
            listItem.textContent = option.text;
            listItem.addEventListener("click", function () {
                regionInput.value = option.text;
                regionSelect.value = option.value;
                regionList.innerHTML = "";
                fetchStopsAndUpdateDropdown();
            });
            regionList.appendChild(listItem);
        });

        if (inputValue === "") {
            regionList.innerHTML = "";
        }
    });

    regionInput.addEventListener("focus", function () {
        regionList.innerHTML = "";
    });

    regionForm.addEventListener("submit", function (event) {
        // Prevent the default form submission
        event.preventDefault();
        // Optionally, you can handle other form submission logic here
    });

    // Event listener for region select change
    regionSelect.addEventListener("change", function () {
        // Optionally, you can enable automatic update when region is selected
        // Fetch stops for the selected region and update stop dropdown
        const selectedRegion = this.value;
        fetch(`/get_stops?region=${selectedRegion}`)
            .then(response => response.json())
            .then(data => updateStopDropdown(data.stops))
            .catch(error => console.error('Error fetching stops:', error));
    });

    // Event listener for stop input
    stopInput.addEventListener("input", function () {
        const inputValue = this.value.toLowerCase();

        // Fetch stops based on the input value and update the stop dropdown
        fetch(`/get_stops_autocomplete?input=${inputValue}`)
            .then(response => response.json())
            .then(data => updateStopDropdown(data.stops))
            .catch(error => console.error('Error fetching stops:', error));
    });

    function updateStopDropdown(stops) {
        // Clear existing options
        stopList.innerHTML = "";
        // Add new options based on server response
        stops.forEach(stop => {
            const listItem = document.createElement("div");
            listItem.textContent = stop;
            listItem.addEventListener("click", function () {
                stopInput.value = stop;
                stopList.innerHTML = "";
            });
            stopList.appendChild(listItem);
        });
    }

    stopInput.addEventListener("focus", function () {
        stopList.innerHTML = "";
    });
});

    </script>
    

</body>

</html>